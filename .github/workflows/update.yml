name: Update version
on:
  schedule:
    - cron: 0 * * * *

jobs:
  update-version:
    name: update-version
    runs-on: ubuntu-latest
    steps:
      - name: Check out code.
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          persist-credentials: false
      - uses: crazy-max/ghaction-import-gpg@v4
        with:
          gpg_private_key: ${{ secrets.GPG_PRIVATE_KEY }}
          git_user_signingkey: true
          git_commit_gpgsign: true
      - name: Run gitwerk semver-auto
        run: |
          CURRENT_VERSION=`cat VALD_CLIENT_CLJ_VERSION`
          VERSION=`curl -s https://api.github.com/repos/vdaas/vald-client-java/releases/latest | jq '.tag_name'`
          if [ "" = "${VERSION}" ]; then
            echo "the version is empty"
            exit 0
          fi
          VERSION="v${VERSION}"

          if [ "$CURRENT_VERSION" = "${VERSION}" ];then
            echo "not updated"
            exit 0
          fi

          VERSION=`curl -fsSL https://repo1.maven.org/maven2/org/vdaas/vald/vald-client-java/ | grep '<a href=' | sed -n 's/.*title="\([^"]*\)\/".*/\1/p' | sort | uniq | tail -n 1`
          if [ "" = "${VERSION}" ]; then
            echo "maven version is empty"
            exit 0
          fi
          VERSION="v${VERSION}"

          if [ "$CURRENT_VERSION" = "${VERSION}" ];then
            echo "not uploaded to maven repository"
            exit 0
          fi

          echo "${VERSION}" > VALD_CLIENT_CLJ_VERSION

          curl -o lein https://raw.githubusercontent.com/technomancy/leiningen/stable/bin/lein
          chmod a+x lein
          ./lein pom
          rm lein

          git config --global user.name "vdaas-ci"
          git config --global user.email "vald@vdaas.org"
          git remote set-url origin "https://${GITHUB_USER}:${GITHUB_TOKEN}@github.com/${GITHUB_REPOSITORY}.git"

          git checkout main
          git add VALD_CLIENT_CLJ_VERSION
          git add pom.xml
          git commit --signoff -m ":bookmark: Release ${VERSION}"

          git tag ${VERSION}
          git remote set-url origin "https://${GITHUB_USER}:${GITHUB_TOKEN}@github.com/${GITHUB_REPOSITORY}.git"

          git push origin main
          git push origin ${VERSION}
        env:
          GITHUB_USER: ${{ secrets.VALDCLI_USER }}
          GITHUB_TOKEN: ${{ secrets.VALDCLI_TOKEN }}
